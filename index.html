<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Support Ticket Chat</title>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(160deg,#020617,#020b2d);
  color:#fff;
}
.hidden{display:none}

.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}

h1{text-align:center;margin-bottom:20px}

input,button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  font-size:16px;
  margin-bottom:12px;
}

input{background:#111827;color:#fff}
button{font-weight:600;cursor:pointer}

.green{background:#22c55e}
.blue{background:#3b82f6}
.red{background:#ef4444}

.chat{
  background:#020617;
  height:60vh;
  overflow-y:auto;
  padding:12px;
  border-radius:12px;
}
.msg{
  margin-bottom:10px;
  max-width:80%;
  padding:10px 14px;
  border-radius:14px;
}
.user{background:#22c55e;color:#000;margin-left:auto}
.admin{background:#1f2933}

.footer{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.footer input{flex:1}
</style>
</head>
<body>

<div class="container">

<!-- LOGIN / CREATE -->
<div id="auth">
  <h1>Create / Login Ticket</h1>

  <button class="green" onclick="showCreate()">Create Ticket</button>

  <input id="loginId" placeholder="Ticket ID">
  <input id="loginPass" type="password" placeholder="Ticket Password">
  <button class="blue" onclick="loginTicket()">Login Ticket</button>

  <hr style="margin:20px 0">

  <h3>Admin Login</h3>
  <input id="adminUser" placeholder="Admin Username">
  <input id="adminPass" type="password" placeholder="Admin Password">
  <button class="red" onclick="adminLogin()">Admin Login</button>
</div>

<!-- CREATE TICKET -->
<div id="create" class="hidden">
  <h1>Create Ticket</h1>
  <input id="cName" placeholder="Your Name">
  <input id="cPass" type="password" placeholder="Create Password">
  <button class="green" onclick="createTicket()">Create</button>
  <button class="red" onclick="back()">Back</button>
</div>

<!-- CHAT -->
<div id="chatBox" class="hidden">
  <h1 id="chatTitle">Chat</h1>

  <div class="chat" id="chat"></div>

  <div class="footer">
    <input id="msg" placeholder="Type messageâ€¦">
    <button class="green" onclick="sendMsg()">Send</button>
  </div>

  <button class="red" onclick="logout()" style="margin-top:10px">Logout</button>
</div>

</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, push, set, get, child, onChildAdded } 
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwqv5thtLTbc2MBxd0QHXKQMNATubJNqw",
  authDomain: "shivansh-codex-chat.firebaseapp.com",
  projectId: "shivansh-codex-chat",
  storageBucket: "shivansh-codex-chat.firebasestorage.app",
  messagingSenderId: "503775406827",
  appId: "1:503775406827:web:b60495fe496a3d4226acae"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentTicket = null;
let isAdmin = false;

/* UI */
window.showCreate=()=>{auth.classList.add("hidden");create.classList.remove("hidden")}
window.back=()=>{create.classList.add("hidden");auth.classList.remove("hidden")}

window.createTicket=async()=>{
  const name=cName.value.trim();
  const pass=cPass.value.trim();
  if(!name||!pass) return alert("Fill all fields");

  const id="T"+Date.now();
  await set(ref(db,"tickets/"+id),{name,pass});
  alert("Your Ticket ID: "+id);
  back();
}

window.loginTicket=async()=>{
  const id=loginId.value.trim();
  const pass=loginPass.value.trim();
  if(!id||!pass) return alert("Fill all fields");

  const snap=await get(child(ref(db),"tickets/"+id));
  if(!snap.exists()||snap.val().pass!==pass) return alert("Invalid ticket");

  currentTicket=id;
  openChat("User: "+snap.val().name);
}

window.adminLogin=()=>{
  if(adminUser.value==="Shivanshcodex" && adminPass.value==="chrome@344"){
    isAdmin=true;
    currentTicket="admin";
    openChat("ADMIN PANEL");
  } else alert("Wrong admin login");
}

function openChat(title){
  auth.classList.add("hidden");
  create.classList.add("hidden");
  chatBox.classList.remove("hidden");
  chatTitle.innerText=title;
  chat.innerHTML="";

  const path=isAdmin?"messages":"messages/"+currentTicket;
  onChildAdded(ref(db,path),s=>{
    const m=s.val();
    const div=document.createElement("div");
    div.className="msg "+m.by;
    div.innerText=m.text;
    chat.appendChild(div);
    chat.scrollTop=chat.scrollHeight;
  });
}

window.sendMsg=()=>{
  const text=msg.value.trim();
  if(!text) return;
  const path=isAdmin?"messages":"messages/"+currentTicket;
  push(ref(db,path),{text,by:isAdmin?"admin":"user"});
  msg.value="";
}

window.logout=()=>location.reload();
</script>
</body>
</html>
